<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yaren & Mahir â€” NiÅŸan AlbÃ¼mÃ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Cinzel:wght@400;600&family=Raleway:wght@200;300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --gold:       #a67c45;
  --gold-light: #c9a96e;
  --gold-dark:  #7a5828;
  --cream-bg:   #f5ede0;
  --cream-card: #fff8ee;
  --text-dark:  #3d2e1a;
  --text-mid:   #6b4f2e;
  --rose:       #c0665d;
  --green:      #3a5f35;
  --border:     rgba(166,124,69,0.28);
  --shadow:     0 4px 24px rgba(166,124,69,0.1);
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--cream-bg);color:var(--text-dark);font-family:'Raleway',sans-serif;min-height:100vh;}
.site-header{text-align:center;padding:52px 20px 36px;background:linear-gradient(to bottom,#eeddd0,var(--cream-bg));border-bottom:1px solid var(--border);}
.header-ornament{font-size:1rem;color:var(--gold-light);letter-spacing:0.7em;display:block;margin-bottom:16px;}
.header-sub{font-family:'Cinzel',serif;font-size:clamp(0.55rem,1.3vw,0.68rem);letter-spacing:0.45em;color:var(--gold);text-transform:uppercase;margin-bottom:10px;display:block;}
.header-title{font-family:'Cormorant Garamond',serif;font-size:clamp(2.4rem,7vw,5rem);font-weight:300;line-height:1;color:var(--text-dark);}
.header-title .amp{font-style:italic;color:var(--gold);font-size:0.65em;margin:0 0.15em;}
.header-tag{font-family:'Cinzel',serif;font-size:clamp(0.5rem,1.2vw,0.62rem);letter-spacing:0.4em;color:var(--text-mid);text-transform:uppercase;margin-top:10px;display:block;}
.divider-thin{display:flex;align-items:center;gap:12px;margin:18px auto 0;width:fit-content;}
.divider-thin .dl{width:60px;height:1px;background:linear-gradient(to right,transparent,var(--gold));}
.divider-thin .dl.r{background:linear-gradient(to left,transparent,var(--gold));}
.divider-thin .dd{width:6px;height:6px;background:var(--gold);transform:rotate(45deg);}
.tabs-wrap{display:flex;justify-content:center;padding:28px 20px 0;max-width:700px;margin:0 auto;}
.tab-btn{flex:1;padding:14px 20px;background:transparent;border:1px solid var(--border);font-family:'Cinzel',serif;font-size:clamp(0.5rem,1.4vw,0.65rem);letter-spacing:0.3em;text-transform:uppercase;color:var(--text-mid);cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;}
.tab-btn:first-child{border-right:none;}
.tab-btn.active{background:var(--gold);color:#fff8ee;border-color:var(--gold);}
.tab-btn:not(.active):hover{background:rgba(166,124,69,0.07);color:var(--gold-dark);}
.section{display:none;max-width:1200px;margin:0 auto;padding:40px 20px 80px;}
.section.active{display:block;}
.section-heading{font-family:'Cinzel',serif;font-size:clamp(0.55rem,1.3vw,0.68rem);letter-spacing:0.45em;color:var(--gold);text-transform:uppercase;text-align:center;margin-bottom:32px;display:flex;align-items:center;gap:14px;justify-content:center;}
.section-heading::before,.section-heading::after{content:'';flex:1;max-width:80px;height:1px;background:var(--border);}
.gallery-toolbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px;}
.gallery-count{font-size:0.78rem;color:var(--text-mid);font-weight:300;}
.toolbar-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.btn-sm{padding:9px 18px;font-family:'Cinzel',serif;font-size:0.55rem;letter-spacing:0.25em;text-transform:uppercase;border:1px solid var(--border);background:transparent;color:var(--text-mid);cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.btn-sm:hover{background:rgba(166,124,69,0.08);border-color:var(--gold);color:var(--gold-dark);}
.btn-sm.primary{background:var(--gold);color:#fff8ee;border-color:var(--gold);}
.btn-sm.primary:hover{background:var(--gold-dark);}
.btn-sm.primary:disabled{opacity:0.5;cursor:not-allowed;}
.btn-sm.danger{background:var(--rose);color:#fff;border-color:var(--rose);}
.btn-sm.danger:hover{background:#a0443b;}
#select-counter{display:none;}
#select-counter.visible{display:flex;}
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
.photo-card{animation:fadeIn 0.5s both;}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
.photo-card-inner{position:relative;border-radius:2px;overflow:hidden;aspect-ratio:4/3;background:#e8ddd0;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;}
.photo-card-inner img{width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.4s ease;}
.photo-card-inner:hover img{transform:scale(1.04);}
.photo-overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(30,15,5,0.85) 0%,rgba(30,15,5,0.1) 55%,transparent 100%);opacity:0;transition:opacity 0.3s;display:flex;align-items:flex-end;}
.photo-card-inner:hover .photo-overlay{opacity:1;}
.photo-overlay-content{padding:12px 12px 10px;width:100%;}
.photo-uploader{font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:0.2em;color:rgba(255,248,238,0.9);margin-bottom:3px;}
.photo-note{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:0.82rem;color:rgba(255,248,238,0.72);line-height:1.4;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.photo-actions{display:flex;gap:6px;}
.btn-icon{width:32px;height:32px;border-radius:50%;background:rgba(255,248,238,0.15);border:1px solid rgba(255,248,238,0.3);color:#fff8ee;font-size:0.72rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;backdrop-filter:blur(4px);}
.btn-icon:hover{background:rgba(166,124,69,0.7);border-color:var(--gold-light);}
.btn-icon.btn-delete:hover{background:rgba(192,102,93,0.8);border-color:#e88880;}
.select-checkbox{position:absolute;top:10px;right:10px;cursor:pointer;z-index:2;display:none;}
.select-checkbox.show{display:block;}
.select-checkbox input{display:none;}
.checkmark{width:26px;height:26px;border:2px solid rgba(255,248,238,0.7);border-radius:50%;background:rgba(30,15,5,0.3);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-size:0.65rem;color:transparent;}
.select-checkbox input:checked + .checkmark{background:var(--gold);border-color:var(--gold);color:#fff;}
#gallery-loader{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:80px 0;color:var(--gold);}
#gallery-loader i{font-size:2rem;animation:spin 1.2s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
#empty-state{display:none;text-align:center;padding:80px 20px;color:var(--text-mid);}
#empty-state i{font-size:3rem;color:var(--border);margin-bottom:16px;display:block;}
#empty-state p{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.2rem;}
.lightbox{position:fixed;inset:0;z-index:1000;background:rgba(20,10,4,0.96);display:none;align-items:center;justify-content:center;flex-direction:column;padding:20px;}
.lightbox.open{display:flex;}
.lightbox-img-wrap{max-width:min(90vw,900px);max-height:72vh;display:flex;align-items:center;justify-content:center;}
.lightbox-img-wrap img{max-width:100%;max-height:72vh;object-fit:contain;border:1px solid rgba(166,124,69,0.3);box-shadow:0 8px 60px rgba(0,0,0,0.6);}
.lightbox-info{margin-top:20px;text-align:center;max-width:600px;}
.lightbox-name{font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.3em;color:var(--gold-light);text-transform:uppercase;margin-bottom:8px;}
.lightbox-note{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.1rem;color:rgba(245,237,224,0.8);line-height:1.6;margin-bottom:16px;}
.lightbox-actions{display:flex;gap:12px;justify-content:center;}
.lightbox-close{position:absolute;top:16px;right:16px;width:44px;height:44px;border-radius:50%;background:rgba(255,248,238,0.08);border:1px solid rgba(255,248,238,0.15);color:#fff8ee;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;z-index:10;}
.lightbox-close:hover{background:rgba(166,124,69,0.5);}
.upload-card{max-width:580px;margin:0 auto;border:1px solid var(--border);background:var(--cream-card);box-shadow:var(--shadow);padding:44px 40px;position:relative;}
.upload-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(to right,transparent,var(--gold),transparent);}
.form-field{margin-bottom:22px;}
.form-label{font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:0.35em;color:var(--gold);text-transform:uppercase;display:block;margin-bottom:8px;}
.form-required{color:var(--rose);margin-left:3px;}
.form-input,.form-textarea{width:100%;padding:12px 14px;background:#fdf8f2;border:1px solid var(--border);font-family:'Raleway',sans-serif;font-size:0.9rem;color:var(--text-dark);font-weight:300;outline:none;transition:border-color 0.3s;border-radius:0;}
.form-input::placeholder,.form-textarea::placeholder{color:rgba(107,79,46,0.45);}
.form-input:focus,.form-textarea:focus{border-color:var(--gold);}
.form-textarea{resize:vertical;min-height:90px;}
.file-drop{border:2px dashed var(--border);padding:36px 20px;text-align:center;cursor:pointer;transition:border-color 0.3s,background 0.3s;background:#fdf8f2;}
.file-drop:hover,.file-drop.drag-over{border-color:var(--gold);background:rgba(166,124,69,0.05);}
.file-drop input{display:none;}
.file-drop i{font-size:2rem;color:var(--gold-light);display:block;margin-bottom:10px;}
.file-drop-text{font-size:0.82rem;color:var(--text-mid);font-weight:300;}
.file-drop-sub{font-size:0.7rem;color:rgba(107,79,46,0.5);margin-top:4px;}
#file-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
.preview-thumb{width:60px;height:60px;object-fit:cover;border:1px solid var(--border);border-radius:2px;}
.upload-btn-wrap{margin-top:28px;text-align:center;}
.btn-upload{padding:15px 44px;background:var(--gold);color:#fff8ee;border:none;font-family:'Cinzel',serif;font-size:0.62rem;letter-spacing:0.35em;text-transform:uppercase;cursor:pointer;display:inline-flex;align-items:center;gap:10px;transition:background 0.3s,transform 0.2s;}
.btn-upload:hover:not(:disabled){background:var(--gold-dark);transform:translateY(-1px);}
.btn-upload:disabled{opacity:0.6;cursor:not-allowed;}
#upload-progress{display:none;margin-top:20px;}
.progress-track{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:8px;}
#progress-bar-fill{height:100%;background:linear-gradient(to right,var(--gold-light),var(--gold));width:0%;transition:width 0.3s;border-radius:2px;}
#upload-status{font-size:0.75rem;color:var(--gold-dark);text-align:center;font-weight:300;}
.modal-overlay{position:fixed;inset:0;z-index:2000;background:rgba(20,10,4,0.7);display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--cream-card);border:1px solid var(--border);box-shadow:0 8px 60px rgba(0,0,0,0.2);padding:40px 36px;max-width:440px;width:100%;position:relative;text-align:center;}
.modal-box::before{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(to right,transparent,var(--gold),transparent);}
.modal-title{font-family:'Cinzel',serif;font-size:0.7rem;letter-spacing:0.4em;color:var(--gold);text-transform:uppercase;margin-bottom:16px;}
.modal-body{font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--text-mid);line-height:1.7;margin-bottom:20px;}
.delete-code-box{margin:20px 0;padding:24px;background:linear-gradient(135deg,#fff8ee,#f5ede0);border:2px solid var(--gold);text-align:center;}
.delete-code-label{font-family:'Cinzel',serif;font-size:0.58rem;letter-spacing:0.4em;color:var(--gold);text-transform:uppercase;margin-bottom:10px;display:block;}
.delete-code-number{font-family:'Cormorant Garamond',serif;font-size:3.5rem;font-weight:300;color:var(--text-dark);letter-spacing:0.3em;display:block;line-height:1;}
.delete-code-warning{font-size:0.75rem;color:var(--rose);margin-top:10px;font-weight:400;display:block;}
.code-input-wrap{display:flex;gap:10px;justify-content:center;margin:16px 0;}
.code-digit{width:52px;height:64px;border:2px solid var(--border);background:#fdf8f2;font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:300;text-align:center;color:var(--text-dark);outline:none;transition:border-color 0.2s;border-radius:2px;}
.code-digit:focus{border-color:var(--gold);}
.modal-actions{display:flex;gap:12px;justify-content:center;margin-top:20px;}
.modal-close-btn{position:absolute;top:12px;right:14px;background:none;border:none;font-size:1.1rem;color:var(--text-mid);cursor:pointer;padding:4px 8px;}
.modal-close-btn:hover{color:var(--rose);}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:12px 28px;font-size:0.82rem;border-radius:2px;z-index:3000;box-shadow:0 4px 20px rgba(0,0,0,0.2);max-width:90vw;text-align:center;display:none;}
.toast.error{background:#7a2a22;color:#ffeae8;}
.toast.success{background:var(--green);color:#e8f5e5;}
.site-footer{text-align:center;padding:28px 20px 40px;border-top:1px solid var(--border);font-family:'Cormorant Garamond',serif;font-style:italic;color:var(--gold-dark);font-size:1rem;}
@media(max-width:600px){.photo-grid{grid-template-columns:repeat(2,1fr);gap:10px;}.upload-card{padding:30px 20px;}.gallery-toolbar{flex-direction:column;align-items:flex-start;}.modal-box{padding:32px 22px;}}
@media(max-width:400px){.photo-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<header class="site-header">
  <span class="header-ornament">âœ¦ &nbsp; âœ¦ &nbsp; âœ¦</span>
  <span class="header-sub">NiÅŸan AlbÃ¼mÃ¼ â€” 26 Nisan 2026</span>
  <h1 class="header-title">Yaren <span class="amp">&amp;</span> Mahir</h1>
  <span class="header-tag">AnÄ±larÄ±mÄ±zÄ± Birlikte Biriktirelim</span>
  <div class="divider-thin">
    <div class="dl"></div><div class="dd"></div><div class="dl r"></div>
  </div>
</header>

<div class="tabs-wrap">
  <button class="tab-btn active" onclick="switchTab('gallery')" id="tab-gallery">
    <i class="fa-solid fa-images"></i> FotoÄŸraflar
  </button>
  <button class="tab-btn" onclick="switchTab('upload')" id="tab-upload">
    <i class="fa-solid fa-cloud-arrow-up"></i> FotoÄŸraf YÃ¼kle
  </button>
</div>

<div class="section active" id="section-gallery">
  <div class="section-heading">TÃ¼m AnÄ±lar</div>
  <div class="gallery-toolbar">
    <span class="gallery-count" id="gallery-count"></span>
    <div class="toolbar-right">
      <span class="btn-sm" id="select-counter"><i class="fa-solid fa-check-square"></i><span id="select-count-text">0 seÃ§ildi</span></span>
      <button class="btn-sm" onclick="toggleSelectMode()" id="btn-select-mode"><i class="fa-solid fa-object-group"></i> Ã‡oklu SeÃ§</button>
      <button class="btn-sm primary" id="btn-download-selected" onclick="downloadSelected()" style="display:none;"><i class="fa-solid fa-download"></i> SeÃ§ilenleri Ä°ndir</button>
      <button class="btn-sm" onclick="loadPhotos()" title="Yenile"><i class="fa-solid fa-rotate-right"></i></button>
    </div>
  </div>
  <div id="gallery-loader">
    <i class="fa-solid fa-spinner"></i>
    <span style="font-size:0.8rem;color:var(--text-mid);letter-spacing:0.1em;">FotoÄŸraflar yÃ¼kleniyor...</span>
  </div>
  <div id="empty-state">
    <i class="fa-solid fa-camera"></i>
    <p>HenÃ¼z fotoÄŸraf yÃ¼klenmemiÅŸ.</p>
    <p style="margin-top:8px;font-size:0.8rem;color:rgba(107,79,46,0.6);">Ä°lk fotoÄŸrafÄ± siz yÃ¼kleyin!</p>
  </div>
  <div class="photo-grid" id="photo-grid"></div>
</div>

<div class="section" id="section-upload">
  <div class="section-heading">AnÄ± PaylaÅŸ</div>
  <div class="upload-card">
    <div class="form-field">
      <label class="form-label" for="upload-name">AdÄ±nÄ±z <span class="form-required">*</span></label>
      <input class="form-input" type="text" id="upload-name" placeholder="AdÄ±nÄ±zÄ± girin" maxlength="60">
    </div>
    <div class="form-field">
      <label class="form-label">FotoÄŸraf <span class="form-required">*</span></label>
      <div class="file-drop" id="file-drop-zone" onclick="document.getElementById('upload-file').click()">
        <input type="file" id="upload-file" accept="image/*" multiple onchange="previewFiles(this)">
        <i class="fa-solid fa-image"></i>
        <p class="file-drop-text" id="file-label-text">FotoÄŸraf seÃ§in veya sÃ¼rÃ¼kleyin</p>
        <p class="file-drop-sub">JPG, PNG, HEIC Â· Birden fazla seÃ§ebilirsiniz</p>
      </div>
      <div id="file-preview"></div>
    </div>
    <div class="form-field">
      <label class="form-label" for="upload-note">Bir Åžeyler YazÄ±n <span style="color:var(--text-mid);font-size:0.85em;letter-spacing:0;">(isteÄŸe baÄŸlÄ±)</span></label>
      <textarea class="form-textarea" id="upload-note" placeholder="Bu anÄ±yla ilgili bir ÅŸeyler yazabilirsiniz..." maxlength="300"></textarea>
    </div>
    <div class="upload-btn-wrap">
      <button class="btn-upload" id="upload-btn" onclick="handleUpload()">
        <i class="fa-solid fa-cloud-arrow-up"></i> YÃ¼kle
      </button>
    </div>
    <div id="upload-progress">
      <div class="progress-track"><div id="progress-bar-fill"></div></div>
      <p id="upload-status"></p>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightboxOutside(event)">
  <button class="lightbox-close" onclick="closeLightbox()"><i class="fa-solid fa-xmark"></i></button>
  <div class="lightbox-img-wrap"><img id="lightbox-img" src="" alt=""></div>
  <div class="lightbox-info">
    <p class="lightbox-name" id="lightbox-name"></p>
    <p class="lightbox-note" id="lightbox-note"></p>
    <div class="lightbox-actions">
      <button class="btn-sm primary" onclick="downloadCurrentLightbox()"><i class="fa-solid fa-download"></i> Ä°ndir</button>
      <button class="btn-sm danger" onclick="openDeleteModal(_lbPid)"><i class="fa-solid fa-trash"></i> Sil</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-success">
  <div class="modal-box">
    <button class="modal-close-btn" onclick="closeModal('modal-success')"><i class="fa-solid fa-xmark"></i></button>
    <div style="font-size:2rem;margin-bottom:12px;">âœ“</div>
    <p class="modal-title">FotoÄŸraf YÃ¼klendi!</p>
    <p class="modal-body">FotoÄŸrafÄ±nÄ±z albÃ¼me eklendi. EÄŸer fotoÄŸrafÄ± silmek isterseniz aÅŸaÄŸÄ±daki kodu kullanÄ±n.</p>
    <div class="delete-code-box">
      <span class="delete-code-label">Silme Kodunuz</span>
      <span class="delete-code-number" id="shown-delete-code">0000</span>
      <span class="delete-code-warning"><i class="fa-solid fa-triangle-exclamation"></i> Bu kodu not alÄ±n! Tekrar gÃ¶sterilmeyecek.</span>
    </div>
    <div class="modal-actions">
      <button class="btn-sm primary" onclick="closeModal('modal-success');switchTab('gallery');loadPhotos();">
        <i class="fa-solid fa-images"></i> Galeriye Git
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-delete">
  <div class="modal-box">
    <button class="modal-close-btn" onclick="closeModal('modal-delete')"><i class="fa-solid fa-xmark"></i></button>
    <div style="font-size:2rem;margin-bottom:12px;color:var(--rose);"><i class="fa-solid fa-trash"></i></div>
    <p class="modal-title">FotoÄŸrafÄ± Sil</p>
    <p class="modal-body">FotoÄŸrafÄ± silmek iÃ§in yÃ¼kleme sÄ±rasÄ±nda size verilen <strong>4 haneli silme kodunu</strong> girin.</p>
    <div class="code-input-wrap">
      <input class="code-digit" type="text" maxlength="1" id="d1" oninput="digitInput(this,'d2')" onkeydown="digitBack(event,this,'')">
      <input class="code-digit" type="text" maxlength="1" id="d2" oninput="digitInput(this,'d3')" onkeydown="digitBack(event,this,'d1')">
      <input class="code-digit" type="text" maxlength="1" id="d3" oninput="digitInput(this,'d4')" onkeydown="digitBack(event,this,'d2')">
      <input class="code-digit" type="text" maxlength="1" id="d4" oninput="digitInput(this,'')"  onkeydown="digitBack(event,this,'d3')">
    </div>
    <p id="delete-error" style="color:var(--rose);font-size:0.8rem;min-height:1.2em;text-align:center;margin-top:4px;"></p>
    <div class="modal-actions">
      <button class="btn-sm" onclick="closeModal('modal-delete')">Ä°ptal</button>
      <button class="btn-sm danger" id="btn-confirm-delete" onclick="confirmDelete()"><i class="fa-solid fa-trash"></i> Sil</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<footer class="site-footer">Yaren &amp; Mahir â€” 26 Nisan 2026 &nbsp;â™¡</footer>

<script>
const CLOUD_NAME    = "dp4kalxzq";
const UPLOAD_PRESET = "nisan_album";
const UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
const LIST_URL   = `https://res.cloudinary.com/${CLOUD_NAME}/image/list/nisan.json`;

function showToast(msg, type='error') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast '+type;
  t.style.display = 'block';
  setTimeout(() => t.style.display='none', 4000);
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function switchTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-'+tab).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
}

/* â”€â”€ CONTEXT PARSER: "key=value|key2=value2" formatÄ±nÄ± objeye Ã§evirir â”€â”€ */
function parseContext(r) {
  try {
    // Cloudinary bazen context'i {custom:{...}} bazen dÃ¼z string olarak verir
    if (r.context && typeof r.context === 'object' && r.context.custom) {
      return r.context.custom;
    }
    if (r.context && typeof r.context === 'string') {
      const obj = {};
      r.context.split('|').forEach(pair => {
        const idx = pair.indexOf('=');
        if (idx > -1) obj[pair.slice(0,idx)] = pair.slice(idx+1);
      });
      return obj;
    }
  } catch(e) {}
  return {};
}

/* â”€â”€ LOAD PHOTOS â”€â”€ */
async function loadPhotos() {
  const grid=document.getElementById('photo-grid'), empty=document.getElementById('empty-state'), loader=document.getElementById('gallery-loader');
  loader.style.display='flex'; grid.innerHTML=''; empty.style.display='none';
  try {
    const res = await fetch(LIST_URL);
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    const resources = (data.resources||[]).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    loader.style.display='none';
    if (!resources.length) { empty.style.display='block'; return; }
    document.getElementById('gallery-count').textContent = resources.length+' fotoÄŸraf';
    resources.forEach((r,i) => {
      const ctx  = parseContext(r);
      const name = (ctx.name || 'Misafir').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const note = (ctx.note || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const url  = r.secure_url || `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${r.public_id}`;
      const thumb= url;
      const pid  = r.public_id || '';

      // onclick iÃ§in JS string escape
      const sn  = name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      const snt = note.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      const su  = url.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      const sp  = pid.replace(/\\/g,'\\\\').replace(/'/g,"\\'");

      const card=document.createElement('div');
      card.className='photo-card'; card.style.animationDelay=(i*0.04)+'s';
      card.innerHTML=`
        <div class="photo-card-inner">
          <img src="${thumb}" alt="NiÅŸan fotoÄŸrafÄ±" loading="lazy">
          <div class="photo-overlay">
            <div class="photo-overlay-content">
              <p class="photo-uploader"><i class="fa-solid fa-user"></i> ${name}</p>
              ${note ? '<p class="photo-note">&quot;'+note+'&quot;</p>' : ''}
              <div class="photo-actions">
                <button class="btn-icon" title="BÃ¼yÃ¼t" onclick="openLightbox('${su}','${sn}','${snt}','${sp}')"><i class="fa-solid fa-expand"></i></button>
                <button class="btn-icon" title="Ä°ndir" onclick="downloadPhoto('${su}','${sp}')"><i class="fa-solid fa-download"></i></button>
                <button class="btn-icon btn-delete" title="Sil" onclick="openDeleteModal('${sp}')"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          </div>
          <label class="select-checkbox" title="SeÃ§">
            <input type="checkbox" class="photo-select" data-url="${url}" data-file="${pid}">
            <span class="checkmark"><i class="fa-solid fa-check"></i></span>
          </label>
        </div>`;
      grid.appendChild(card);
    });
  } catch(e) {
    loader.style.display='none'; empty.style.display='block';
    console.error('loadPhotos error:', e);
  }
}

function generateCode() { return String(Math.floor(1000 + Math.random() * 9000)); }

async function handleUpload() {
  const nameVal=document.getElementById('upload-name').value.trim();
  const noteVal=document.getElementById('upload-note').value.trim();
  const fileInp=document.getElementById('upload-file');
  const files=fileInp.files;
  if (!nameVal)      { showToast('LÃ¼tfen adÄ±nÄ±zÄ± girin.'); return; }
  if (!files.length) { showToast('LÃ¼tfen en az bir fotoÄŸraf seÃ§in.'); return; }

  const btn=document.getElementById('upload-btn'), prog=document.getElementById('upload-progress'), bar=document.getElementById('progress-bar-fill'), status=document.getElementById('upload-status');
  btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...'; prog.style.display='block';

  const deleteCode = generateCode();
  let done=0;

  try {
    for (const file of files) {
      const fd=new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      fd.append('tags', 'nisan');
      fd.append('context', 'name='+encodeURIComponent(nameVal)+'|note='+encodeURIComponent(noteVal)+'|deleteCode='+deleteCode);

      await new Promise((resolve,reject) => {
        const xhr=new XMLHttpRequest();
        xhr.open('POST', UPLOAD_URL);
        xhr.upload.onprogress=e => {
          if (e.lengthComputable) {
            const pct=Math.round(((done+e.loaded/e.total)/files.length)*100);
            bar.style.width=pct+'%';
            status.textContent=(done+1)+' / '+files.length+' yÃ¼kleniyor... %'+pct;
          }
        };
        xhr.onload=()=>{ if(xhr.status===200){done++;resolve();}else reject(new Error(xhr.status)); };
        xhr.onerror=reject;
        xhr.send(fd);
      });
    }

    bar.style.width='100%';
    status.textContent=files.length+' fotoÄŸraf yÃ¼klendi!';

    setTimeout(() => {
      btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-cloud-arrow-up"></i> YÃ¼kle';
      prog.style.display='none'; bar.style.width='0';
      document.getElementById('upload-name').value='';
      document.getElementById('upload-note').value='';
      fileInp.value='';
      document.getElementById('file-preview').innerHTML='';
      document.getElementById('file-label-text').textContent='FotoÄŸraf seÃ§in veya sÃ¼rÃ¼kleyin';
      document.getElementById('shown-delete-code').textContent = deleteCode;
      openModal('modal-success');
    }, 1200);

  } catch(e) {
    btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-cloud-arrow-up"></i> YÃ¼kle'; prog.style.display='none';
    showToast('YÃ¼kleme baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.');
    console.error('upload error:', e);
  }
}

function previewFiles(input) {
  const preview=document.getElementById('file-preview'), label=document.getElementById('file-label-text');
  preview.innerHTML='';
  if (!input.files.length) { label.textContent='FotoÄŸraf seÃ§in veya sÃ¼rÃ¼kleyin'; return; }
  label.textContent=input.files.length+' fotoÄŸraf seÃ§ildi';
  Array.from(input.files).slice(0,12).forEach(file => {
    const reader=new FileReader();
    reader.onload=e => { const img=document.createElement('img'); img.className='preview-thumb'; img.src=e.target.result; preview.appendChild(img); };
    reader.readAsDataURL(file);
  });
}

const dropZone=document.getElementById('file-drop-zone');
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');const input=document.getElementById('upload-file');input.files=e.dataTransfer.files;previewFiles(input);});

let _lbUrl='', _lbFile='', _lbPid='';
function openLightbox(url,name,note,pid) {
  document.getElementById('lightbox-img').src=url;
  document.getElementById('lightbox-name').textContent=name ? 'ðŸ“· '+name : '';
  const ne=document.getElementById('lightbox-note');
  ne.textContent=note ? '"'+note+'"' : '';
  ne.style.display=note ? 'block' : 'none';
  _lbUrl=url; _lbFile=pid; _lbPid=pid;
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.getElementById('lightbox-img').src='';
  document.body.style.overflow='';
}
function closeLightboxOutside(e) { if (e.target===document.getElementById('lightbox')) closeLightbox(); }
document.addEventListener('keydown',e=>{ if (e.key==='Escape') { closeLightbox(); closeModal('modal-delete'); closeModal('modal-success'); }});
function downloadCurrentLightbox() { downloadPhoto(_lbUrl,_lbFile); }

async function downloadPhoto(url,filename) {
  try {
    const res=await fetch(url); const blob=await res.blob();
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=(filename ? filename.split('/').pop() : 'nisan-foto')+'.jpg';
    a.click(); URL.revokeObjectURL(a.href);
  } catch { window.open(url,'_blank'); }
}

let _deletePid = '';
function openDeleteModal(pid) {
  _deletePid = pid;
  ['d1','d2','d3','d4'].forEach(id => document.getElementById(id).value='');
  document.getElementById('delete-error').textContent='';
  document.getElementById('btn-confirm-delete').disabled=false;
  document.getElementById('btn-confirm-delete').innerHTML='<i class="fa-solid fa-trash"></i> Sil';
  openModal('modal-delete');
  setTimeout(()=>document.getElementById('d1').focus(),100);
}
function digitInput(el, nextId) {
  el.value = el.value.replace(/\D/g,'');
  if (el.value && nextId) document.getElementById(nextId)?.focus();
}
function digitBack(e, el, prevId) {
  if (e.key==='Backspace' && !el.value && prevId) document.getElementById(prevId)?.focus();
}

async function confirmDelete() {
  const code = ['d1','d2','d3','d4'].map(id=>document.getElementById(id).value).join('');
  if (code.length < 4) { document.getElementById('delete-error').textContent='LÃ¼tfen 4 haneli kodu eksiksiz girin.'; return; }
  const btn=document.getElementById('btn-confirm-delete');
  btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Siliniyor...';
  document.getElementById('delete-error').textContent='';
  try {
    const res = await fetch('/.netlify/functions/delete-photo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ publicId: _deletePid, deleteCode: code })
    });
    const data = await res.json();
    if (res.ok && data.success) {
      closeModal('modal-delete'); closeLightbox();
      showToast('FotoÄŸraf silindi.', 'success');
      loadPhotos();
    } else {
      document.getElementById('delete-error').textContent = data.error || 'Silme baÅŸarÄ±sÄ±z.';
      btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-trash"></i> Sil';
    }
  } catch(e) {
    document.getElementById('delete-error').textContent='BaÄŸlantÄ± hatasÄ±. Tekrar deneyin.';
    btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-trash"></i> Sil';
  }
}

let selectMode=false;
function toggleSelectMode() {
  selectMode=!selectMode;
  const btn=document.getElementById('btn-select-mode'), dlBtn=document.getElementById('btn-download-selected'), ctr=document.getElementById('select-counter');
  document.querySelectorAll('.select-checkbox').forEach(el=>{ el.classList.toggle('show',selectMode); if(!selectMode) el.querySelector('input').checked=false; });
  if (selectMode) { btn.innerHTML='<i class="fa-solid fa-xmark"></i> Ä°ptal'; btn.classList.add('primary'); dlBtn.style.display='flex'; ctr.classList.add('visible'); }
  else { btn.innerHTML='<i class="fa-solid fa-object-group"></i> Ã‡oklu SeÃ§'; btn.classList.remove('primary'); dlBtn.style.display='none'; ctr.classList.remove('visible'); }
  updateSelectCounter();
}
function updateSelectCounter() { document.getElementById('select-count-text').textContent=document.querySelectorAll('.photo-select:checked').length+' seÃ§ildi'; }
document.addEventListener('change',e=>{ if(e.target.classList.contains('photo-select')) updateSelectCounter(); });

async function downloadSelected() {
  const checked=document.querySelectorAll('.photo-select:checked');
  if (!checked.length) { showToast('LÃ¼tfen Ã¶nce fotoÄŸraf seÃ§in.'); return; }
  const btn=document.getElementById('btn-download-selected');
  btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Ä°ndiriliyor...';
  for (const cb of checked) { await downloadPhoto(cb.dataset.url,cb.dataset.file); await new Promise(r=>setTimeout(r,500)); }
  btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-download"></i> SeÃ§ilenleri Ä°ndir';
  showToast(checked.length+' fotoÄŸraf indirildi.','success');
}

window.addEventListener('load', loadPhotos);
</script>
</body>
</html>
